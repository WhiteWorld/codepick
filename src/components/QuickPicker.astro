---
import { t, type Locale } from '../lib/i18n';

interface Props {
  lang?: Locale;
}
const { lang = 'zh' } = Astro.props;
---

<div class="card p-6 md:p-8" id="quick-picker">
  <h2 class="text-xl font-bold text-white mb-2 mt-0">{t('qp.title', lang)}</h2>
  <p class="text-sm text-[var(--text-muted)] mb-6">{t('qp.subtitle', lang)}</p>

  <!-- Step 1 -->
  <div class="picker-step" data-step="1">
    <p class="text-sm font-medium text-[var(--text-secondary)] mb-3">{t('qp.step1', lang)}</p>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
      <button class="picker-option btn btn-ghost justify-center" data-key="env" data-value="vscode">{t('qp.envVscode', lang)}</button>
      <button class="picker-option btn btn-ghost justify-center" data-key="env" data-value="jetbrains">{t('qp.envJetbrains', lang)}</button>
      <button class="picker-option btn btn-ghost justify-center" data-key="env" data-value="terminal">{t('qp.envTerminal', lang)}</button>
      <button class="picker-option btn btn-ghost justify-center" data-key="env" data-value="any">{t('qp.envAny', lang)}</button>
    </div>
  </div>

  <!-- Step 2 -->
  <div class="picker-step hidden" data-step="2">
    <p class="text-sm font-medium text-[var(--text-secondary)] mb-3">{t('qp.step2', lang)}</p>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
      <button class="picker-option btn btn-ghost justify-center" data-key="budget" data-value="free">{t('qp.budgetFree', lang)}</button>
      <button class="picker-option btn btn-ghost justify-center" data-key="budget" data-value="low">{t('qp.budgetLow', lang)}</button>
      <button class="picker-option btn btn-ghost justify-center" data-key="budget" data-value="mid">{t('qp.budgetMid', lang)}</button>
      <button class="picker-option btn btn-ghost justify-center" data-key="budget" data-value="high">{t('qp.budgetHigh', lang)}</button>
    </div>
  </div>

  <!-- Step 3 -->
  <div class="picker-step hidden" data-step="3">
    <p class="text-sm font-medium text-[var(--text-secondary)] mb-3">{t('qp.step3', lang)}</p>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
      <button class="picker-option btn btn-ghost justify-center" data-key="priority" data-value="power">{t('qp.priPower', lang)}</button>
      <button class="picker-option btn btn-ghost justify-center" data-key="priority" data-value="cheap">{t('qp.priCheap', lang)}</button>
      <button class="picker-option btn btn-ghost justify-center" data-key="priority" data-value="china">{t('qp.priChina', lang)}</button>
      <button class="picker-option btn btn-ghost justify-center" data-key="priority" data-value="flex">{t('qp.priFlex', lang)}</button>
      <button class="picker-option btn btn-ghost justify-center" data-key="priority" data-value="privacy">{t('qp.priPrivacy', lang)}</button>
      <button class="picker-option btn btn-ghost justify-center" data-key="priority" data-value="easy">{t('qp.priEasy', lang)}</button>
    </div>
  </div>

  <!-- Result -->
  <div class="picker-step hidden" data-step="result">
    <div class="text-center py-4">
      <p class="text-sm text-[var(--text-muted)] mb-2">{t('qp.resultLabel', lang)}</p>
      <div id="picker-result" class="text-xl font-bold text-white">{t('qp.calculating', lang)}</div>
      <p id="picker-reason" class="text-sm text-[var(--text-muted)] mt-2"></p>
      <button class="btn btn-ghost mt-4" id="picker-reset">{t('qp.reset', lang)}</button>
    </div>
  </div>

  <!-- Progress bar -->
  <div class="mt-4 flex gap-1.5">
    <div class="picker-progress h-1 rounded-full flex-1 bg-[var(--brand-500)]" data-for="1"></div>
    <div class="picker-progress h-1 rounded-full flex-1 bg-[var(--surface-border)]" data-for="2"></div>
    <div class="picker-progress h-1 rounded-full flex-1 bg-[var(--surface-border)]" data-for="3"></div>
  </div>
</div>

<script define:vars={{ lang }}>
  const answers = {};
  let currentStep = 1;

  // Bilingual recommendation reasons
  const reasons = {
    zh: {
      opencode_ark: '终端原生 + 国内 API，低成本高效率',
      claude_code: '终端最强 AI 编程体验，支持多 Agent 协作',
      copilot_easy: 'JetBrains 原生支持，开箱即用',
      copilot_jetbrains: 'JetBrains 生态最成熟的 AI 编程方案',
      aider_ollama_privacy: '完全免费 + 100% 本地，代码不出机器',
      cline_ark_cheap: '¥8.9/月起享受 Agent 级 AI 编程，性价比之王',
      cline_ark_china: '国内 API 直连，低延迟 + 低成本',
      trae_ark: '字节出品 IDE，国内体验最优',
      cursor_pro: '当前综合体验最强的 AI IDE，Tab 补全 + Agent 无缝切换',
      cline_ark_flex: '自由切换模型和 API，最大灵活性',
      aider_ollama_local: '完全本地运行，代码零上传',
      cline_ark_default: '综合性价比最优的入门方案',
    },
    en: {
      opencode_ark: 'Terminal-native + China API, low cost high efficiency',
      claude_code: 'Best terminal AI coding experience, multi-Agent support',
      copilot_easy: 'Native JetBrains support, works out of the box',
      copilot_jetbrains: 'Most mature AI coding solution for JetBrains',
      aider_ollama_privacy: 'Completely free + 100% local, code never leaves your machine',
      cline_ark_cheap: 'Agent-level AI coding from ¥8.9/mo, best value',
      cline_ark_china: 'Direct China API access, low latency + low cost',
      trae_ark: 'ByteDance IDE, best China experience',
      cursor_pro: 'Best overall AI IDE experience, seamless Tab + Agent',
      cline_ark_flex: 'Freely switch models and APIs, maximum flexibility',
      aider_ollama_local: 'Fully local execution, zero code upload',
      cline_ark_default: 'Best value starter plan overall',
    },
  };

  function recommend(a) {
    const { env, budget, priority } = a;
    const r = reasons[lang] || reasons.zh;

    if (env === 'terminal') {
      if (budget === 'free' || budget === 'low') {
        return { name: 'OpenCode + 方舟 Coding Plan', id: 'opencode-ark', reason: r.opencode_ark };
      }
      return { name: 'Claude Code', id: 'claude-code', reason: r.claude_code };
    }

    if (env === 'jetbrains') {
      if (priority === 'easy') {
        return { name: 'GitHub Copilot Pro', id: 'copilot-pro', reason: r.copilot_easy };
      }
      return { name: 'GitHub Copilot Pro', id: 'copilot-pro', reason: r.copilot_jetbrains };
    }

    if (budget === 'free' || priority === 'cheap') {
      if (priority === 'privacy') {
        return { name: 'Aider + Ollama', id: 'aider-ollama', reason: r.aider_ollama_privacy };
      }
      return { name: 'Cline + 方舟 Coding Plan', id: 'cline-ark', reason: r.cline_ark_cheap };
    }

    if (priority === 'china') {
      if (budget === 'free' || budget === 'low') {
        return { name: 'Cline + 方舟 Coding Plan', id: 'cline-ark', reason: r.cline_ark_china };
      }
      return { name: 'Trae + 方舟 Coding Plan', id: 'trae-ark', reason: r.trae_ark };
    }

    if (priority === 'power' || budget === 'high') {
      return { name: 'Cursor Pro', id: 'cursor-pro', reason: r.cursor_pro };
    }

    if (priority === 'flex') {
      return { name: 'Cline + 方舟 Coding Plan', id: 'cline-ark', reason: r.cline_ark_flex };
    }

    if (priority === 'privacy') {
      return { name: 'Aider + Ollama', id: 'aider-ollama', reason: r.aider_ollama_local };
    }

    return { name: 'Cline + 方舟 Coding Plan', id: 'cline-ark', reason: r.cline_ark_default };
  }

  function showStep(step) {
    document.querySelectorAll('.picker-step').forEach(el => el.classList.add('hidden'));
    const target = document.querySelector(`.picker-step[data-step="${step}"]`);
    target?.classList.remove('hidden');

    document.querySelectorAll('.picker-progress').forEach(el => {
      const forStep = parseInt(el.dataset.for || '0');
      if (step === 'result' || forStep <= (typeof step === 'number' ? step : 3)) {
        el.classList.remove('bg-[var(--surface-border)]');
        el.classList.add('bg-[var(--brand-500)]');
      } else {
        el.classList.add('bg-[var(--surface-border)]');
        el.classList.remove('bg-[var(--brand-500)]');
      }
    });
  }

  document.querySelectorAll('.picker-option').forEach(btn => {
    btn.addEventListener('click', () => {
      const el = btn;
      const key = el.dataset.key;
      const value = el.dataset.value;
      answers[key] = value;

      el.parentElement?.querySelectorAll('.picker-option').forEach(b => {
        b.classList.remove('btn-primary');
        b.classList.add('btn-ghost');
      });
      el.classList.remove('btn-ghost');
      el.classList.add('btn-primary');

      setTimeout(() => {
        if (currentStep < 3) {
          currentStep++;
          showStep(currentStep);
        } else {
          const r = recommend(answers);
          const resultEl = document.getElementById('picker-result');
          const reasonEl = document.getElementById('picker-reason');
          if (resultEl) resultEl.textContent = r.name;
          if (reasonEl) reasonEl.textContent = r.reason;
          showStep('result');

          document.querySelectorAll('[data-plan-id]').forEach(card => {
            card.style.outline = '';
          });
          const matchCard = document.querySelector(`[data-plan-id="${r.id}"]`);
          if (matchCard) {
            matchCard.style.outline = '2px solid var(--brand-500)';
            matchCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }
      }, 300);
    });
  });

  document.getElementById('picker-reset')?.addEventListener('click', () => {
    Object.keys(answers).forEach(k => delete answers[k]);
    currentStep = 1;
    showStep(1);
    document.querySelectorAll('.picker-option').forEach(b => {
      b.classList.remove('btn-primary');
      b.classList.add('btn-ghost');
    });
    document.querySelectorAll('[data-plan-id]').forEach(card => {
      card.style.outline = '';
    });
  });
</script>
