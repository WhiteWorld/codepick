---
import BaseLayout from '../layouts/BaseLayout.astro';
import { t, localePath, monthLabel, type Locale } from '../lib/i18n';
import fs from 'node:fs';
import path from 'node:path';
import yaml from 'js-yaml';

interface Props { lang: Locale }
const { lang } = Astro.props;

// â”€â”€ 1. ç«™ç‚¹çº§ changelog â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const siteLog = yaml.load(
  fs.readFileSync(path.resolve('data/site-changelog.yaml'), 'utf-8')
) as { entries: { date: string; type: string; title: string; items: string[] }[] };

// â”€â”€ 2. èšåˆå·¥å…· / API çš„ changelog æ¡ç›® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
interface ToolEntry {
  date: string;
  type?: string;
  summary: string;
  sourceName: string;
  sourceId: string;
  sourceKind: 'tool' | 'api';
}

function loadDirChangelogs(subdir: string, kind: 'tool' | 'api'): ToolEntry[] {
  const dir = path.resolve(`data/${subdir}`);
  if (!fs.existsSync(dir)) return [];
  return fs.readdirSync(dir)
    .filter(f => f.endsWith('.yaml') || f.endsWith('.yml'))
    .flatMap(f => {
      const raw = yaml.load(fs.readFileSync(path.join(dir, f), 'utf-8')) as any;
      const entries: any[] = raw.changelog || [];
      return entries.map(e => ({
        date: String(e.date),
        type: e.type || 'update',
        summary: e.summary || '',
        sourceName: raw.name || f.replace(/\.ya?ml$/, ''),
        sourceId: raw.id || f.replace(/\.ya?ml$/, ''),
        sourceKind: kind,
      }));
    });
}

const toolEntries = [
  ...loadDirChangelogs('tools', 'tool'),
  ...loadDirChangelogs('apis', 'api'),
].sort((a, b) => b.date.localeCompare(a.date));

// â”€â”€ 3. æŒ‰æœˆåˆ†ç»„å·¥å…·æ¡ç›® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function monthKey(dateStr: string) {
  return dateStr.slice(0, 7); // "2026-02"
}

// Collect all months from both sources
const allMonths = [...new Set([
  ...siteLog.entries.map(e => monthKey(e.date)),
  ...toolEntries.map(e => monthKey(e.date)),
])].sort((a, b) => b.localeCompare(a));

const typeIcon: Record<string, string> = {
  launch:  'ğŸ‰',
  feature: 'âœ¨',
  content: 'ğŸ“',
  seo:     'ğŸ”',
  pricing: 'ğŸ’°',
  model:   'ğŸ¤–',
  update:  'ğŸ”„',
  fix:     'ğŸ›',
  announcement: 'ğŸ“¢',
};

const seoTitle = lang === 'zh' ? 'æ›´æ–°æ—¥å¿— | CodePick' : 'Changelog | CodePick';
const seoDesc = lang === 'zh'
  ? 'CodePick ç«™ç‚¹åŠŸèƒ½æ›´æ–°å’Œ AI ç¼–ç¨‹å·¥å…·åŠ¨æ€ï¼ŒåŒ…æ‹¬æ–°å·¥å…·ã€å®šä»·å˜åŒ–ã€æ–°æ¨¡å‹ä¸Šçº¿ç­‰ã€‚'
  : 'CodePick site updates and AI coding tool changes, including new tools, pricing changes, and new models.';
---

<BaseLayout
  title={seoTitle}
  description={seoDesc}
  lang={lang}
>
  <section class="container py-12 max-w-3xl">
    <h1 class="text-3xl font-bold text-white mb-2">{t('cl.title', lang)}</h1>
    <p class="text-[var(--text-secondary)] mb-8">
      {t('cl.subtitle', lang)}
    </p>

    <div class="space-y-12">
      {allMonths.map(month => {
        const sitePosts = siteLog.entries.filter(e => monthKey(e.date) === month);
        const toolPosts = toolEntries.filter(e => monthKey(e.date) === month);
        if (sitePosts.length === 0 && toolPosts.length === 0) return null;

        return (
          <div>
            {/* Month header */}
            <h2 class="text-base font-semibold text-[var(--brand-400)] mb-4 mt-0 flex items-center gap-2">
              <span class="inline-block w-2 h-2 rounded-full bg-[var(--brand-400)]"></span>
              {monthLabel(month, lang)}
            </h2>

            <div class="space-y-4 pl-4 border-l border-[var(--surface-border)]">
              {/* Site-level entries */}
              {sitePosts.map(entry => (
                <div class="relative">
                  <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-[var(--brand-500)] border-2 border-[var(--surface-bg)]"></div>
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-xs text-[var(--text-muted)]">{entry.date}</span>
                    <span class="tag tag-primary text-xs">{typeIcon[entry.type]} {t(`cl.${entry.type}`, lang)}</span>
                  </div>
                  <h3 class="text-sm font-semibold text-white mt-0 mb-2">{entry.title}</h3>
                  <ul class="text-xs text-[var(--text-secondary)] space-y-1 m-0 pl-4 list-disc">
                    {entry.items.map(item => <li>{item}</li>)}
                  </ul>
                </div>
              ))}

              {/* Tool / API entries grouped by date */}
              {toolPosts.length > 0 && (
                <div class="relative">
                  <div class="absolute -left-[21px] top-1 w-3 h-3 rounded-full bg-[var(--surface-hover)] border-2 border-[var(--surface-border)]"></div>
                  <div class="flex items-center gap-2 mb-2">
                    <span class="text-xs text-[var(--text-muted)]">{month}</span>
                    <span class="tag text-xs">{t('cl.toolUpdates', lang)}</span>
                  </div>
                  <div class="space-y-2">
                    {toolPosts.map(e => (
                      <div class="flex gap-2 text-xs">
                        <span class="text-[var(--text-muted)] shrink-0 w-20">{e.date}</span>
                        <a
                          href={localePath(`/${e.sourceKind}/${e.sourceId}`, lang)}
                          class="text-[var(--brand-400)] no-underline hover:underline shrink-0 font-medium"
                        >
                          {e.sourceName}
                        </a>
                        <span class="text-[var(--text-secondary)]">{e.summary}</span>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>
        );
      })}
    </div>

    <div class="mt-12 text-center text-xs text-[var(--text-muted)]">
      {t('cl.dataError', lang)}
      <a href="https://github.com/WhiteWorld/codepick/issues/new" target="_blank" rel="noopener" class="text-[var(--brand-400)] no-underline hover:underline">{t('link.submitIssue', lang)}</a>
    </div>
  </section>
</BaseLayout>
