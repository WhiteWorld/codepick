---
import BaseLayout from '../layouts/BaseLayout.astro';
import ScoreBar from '../components/ScoreBar.astro';
import { getToolLocalized, getApi, overallScore } from '../lib/data';
import { t, localePath, type Locale } from '../lib/i18n';
import type { Plan } from '../lib/data';

interface Props { plan: Plan; lang: Locale }
const { plan, lang } = Astro.props;

const clientTool = getToolLocalized(plan.client, lang);
const apiSource = getApi(plan.api);
const overall = overallScore(plan.scores);
const bestFor = plan.best_for || [];
const quickStart = plan.quick_start || [];
const pros = plan.pros || [];
const cons = plan.cons || [];
const tags = plan.tags || [];

const siteUrl = 'https://codepick.dev';
const planPath = localePath(`/plan/${plan.id}`, lang);
const planUrl = `${siteUrl}${planPath}`;
const planDescription = plan.tagline || (lang === 'zh'
  ? `${plan.name} - AI 编程方案详解，包含价格、评分、配置指南`
  : `${plan.name} - AI coding plan review with pricing, scores, and setup guide`);

const costStr = plan.monthly_cost || '';
const priceNum = parseFloat(costStr.replace(/[^0-9.]/g, '')) || 0;
const priceCurrency = plan.currency === 'CNY' ? 'CNY' : 'USD';

const productSchema: object = {
  '@context': 'https://schema.org',
  '@type': 'Product',
  name: plan.name,
  url: planUrl,
  description: planDescription,
  inLanguage: lang === 'zh' ? 'zh-CN' : 'en',
  aggregateRating: {
    '@type': 'AggregateRating',
    ratingValue: overall,
    bestRating: 10,
    worstRating: 1,
    ratingCount: 1,
  },
  offers: {
    '@type': 'Offer',
    price: priceNum,
    priceCurrency,
    description: `${plan.name} ${lang === 'zh' ? '每月费用约' : 'monthly cost ~'} ${costStr}`,
  },
};

const breadcrumbSchema: object = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: t('bread.home', lang), item: siteUrl },
    { '@type': 'ListItem', position: 2, name: plan.name, item: planUrl },
  ],
};

const seoTitle = lang === 'zh'
  ? `${plan.name} 方案详解 | CodePick`
  : `${plan.name} Plan Review | CodePick`;
---

<BaseLayout
  title={seoTitle}
  description={planDescription}
  jsonLd={[productSchema, breadcrumbSchema]}
  lang={lang}
>
  <article class="container py-12 max-w-4xl">
    <nav class="text-xs text-[var(--text-muted)] mb-6">
      <a href={localePath('/', lang)} class="hover:text-white no-underline">{t('bread.home', lang)}</a>
      <span class="mx-1">/</span>
      <span class="text-[var(--text-secondary)]">{plan.name}</span>
    </nav>

    <div class="mb-8">
      <div class="flex items-center gap-3 mb-2">
        <h1 class="text-2xl md:text-3xl font-bold text-white m-0">{plan.name}</h1>
        {plan.badge && <span class="badge text-sm">{plan.badge}</span>}
      </div>
      <p class="text-[var(--text-secondary)] m-0 mb-4">{plan.tagline}</p>
      <div class="flex items-center gap-4">
        <span class="text-2xl font-bold text-white">{plan.monthly_cost}</span>
        <span class="text-[var(--text-muted)]">{plan.currency}{t('price.perMonth', lang)}</span>
        <span class="text-[var(--text-muted)]">·</span>
        <span class="tag tag-primary">{t('score.overall', lang)} {overall}</span>
      </div>
    </div>

    <section class="card p-6 mb-8">
      <h2 class="text-lg font-semibold text-white mb-4 mt-0">{t('section.planScores', lang)}</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="flex flex-col gap-3">
          <ScoreBar label={t('score.codingAbility', lang)} score={plan.scores.coding_ability} color="auto" />
          <ScoreBar label={t('score.costEfficiency', lang)} score={plan.scores.cost_efficiency} color="auto" />
        </div>
        <div class="flex flex-col gap-3">
          <ScoreBar label={t('score.flexibility', lang)} score={plan.scores.flexibility} color="auto" />
          <ScoreBar label={t('score.chinaFriendly', lang)} score={plan.scores.china_friendly} color="auto" />
        </div>
      </div>
    </section>

    <section class="card p-6 mb-8">
      <h2 class="text-lg font-semibold text-white mb-4 mt-0">{t('section.composition', lang)}</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="bg-[var(--surface-hover)] rounded-lg p-4">
          <div class="text-xs text-[var(--text-muted)] mb-1">{t('comp.client', lang)}</div>
          <div class="font-semibold text-white">{clientTool?.name || plan.client}</div>
          {clientTool && (
            <a href={localePath(`/tool/${clientTool.id}`, lang)} class="text-xs text-[var(--brand-400)] no-underline">{t('comp.viewDetail', lang)}</a>
          )}
        </div>
        <div class="bg-[var(--surface-hover)] rounded-lg p-4">
          <div class="text-xs text-[var(--text-muted)] mb-1">{t('comp.api', lang)}</div>
          <div class="font-semibold text-white">{apiSource?.name || plan.api}</div>
          {apiSource && (
            <span class="text-xs text-[var(--text-muted)]">{apiSource.provider}</span>
          )}
        </div>
        <div class="bg-[var(--surface-hover)] rounded-lg p-4">
          <div class="text-xs text-[var(--text-muted)] mb-1">{t('comp.environment', lang)}</div>
          <div class="font-semibold text-white">{plan.environment || '—'}</div>
          <span class="text-xs text-[var(--text-muted)]">{t('comp.difficulty', lang)} {plan.setup_difficulty}</span>
        </div>
      </div>
    </section>

    {quickStart.length > 0 && (
      <section class="card p-6 mb-8">
        <h2 class="text-lg font-semibold text-white mb-4 mt-0">{t('section.quickStart', lang)}</h2>
        <ol class="list-decimal list-inside text-sm text-[var(--text-secondary)] space-y-2 m-0 pl-0">
          {quickStart.map(step => <li>{step}</li>)}
        </ol>
      </section>
    )}

    {(pros.length > 0 || cons.length > 0) && (
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        {pros.length > 0 && (
          <div class="card p-6">
            <h3 class="text-base font-semibold text-green-400 mb-3 mt-0">{t('section.pros', lang)}</h3>
            <ul class="list-none text-sm text-[var(--text-secondary)] space-y-1.5 m-0 p-0">
              {pros.map(p => <li>+ {p}</li>)}
            </ul>
          </div>
        )}
        {cons.length > 0 && (
          <div class="card p-6">
            <h3 class="text-base font-semibold text-red-400 mb-3 mt-0">{t('section.cons', lang)}</h3>
            <ul class="list-none text-sm text-[var(--text-secondary)] space-y-1.5 m-0 p-0">
              {cons.map(c => <li>- {c}</li>)}
            </ul>
          </div>
        )}
      </div>
    )}

    {bestFor.length > 0 && (
      <section class="card p-6 mb-8">
        <h2 class="text-lg font-semibold text-white mb-4 mt-0">{t('section.bestFor', lang)}</h2>
        <div class="flex flex-wrap gap-2">
          {bestFor.map(b => <span class="tag tag-primary">{b}</span>)}
        </div>
      </section>
    )}

    {tags.length > 0 && (
      <div class="flex flex-wrap gap-2 mb-8">
        {tags.map(tg => <span class="tag">{tg}</span>)}
      </div>
    )}
  </article>
</BaseLayout>
