---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getAllToolsLocalized } from '../lib/data';
import { t, localePath, type Locale } from '../lib/i18n';

interface Props { lang: Locale }
const { lang } = Astro.props;

const allTools = getAllToolsLocalized(lang);
const siteUrl = 'https://codepick.dev';
const pagePath = localePath('/tools/overview', lang);
const tools = [...allTools].sort((a, b) => (b.scores.coding_ability ?? 0) - (a.scores.coding_ability ?? 0));

function priceLabel(tool: any): string {
  const plans = tool.pricing?.plans || [];
  const free = plans.find((p: any) => p.price === 0);
  const paid = plans.find((p: any) => typeof p.price === 'number' && p.price > 0);
  if (free && paid) return lang === 'zh' ? `免费 / $${paid.price}起` : `Free / $${paid.price}+`;
  if (free) return t('price.free', lang);
  if (paid) {
    const currency = tool.pricing?.currency === 'CNY' ? '¥' : '$';
    return `${currency}${paid.price}${t('price.perMonth', lang)}`;
  }
  return t('price.payAsYouGo', lang);
}

function scoreColor(score: number): string {
  if (score >= 8.5) return 'text-green-400';
  if (score >= 7) return 'text-[var(--brand-400)]';
  if (score >= 5) return 'text-yellow-400';
  return 'text-red-400';
}

const jsonLd = {
  '@context': 'https://schema.org',
  '@type': 'ItemList',
  name: lang === 'zh' ? '2026 AI 编程工具全景图' : '2026 AI Coding Tools Overview',
  url: `${siteUrl}${pagePath}`,
  numberOfItems: tools.length,
  itemListElement: tools.map((tl, i) => ({
    '@type': 'ListItem',
    position: i + 1,
    name: tl.name,
    url: `${siteUrl}${localePath(`/tool/${tl.id}`, lang)}`,
  })),
};

const breadcrumb = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: t('bread.home', lang), item: siteUrl },
    { '@type': 'ListItem', position: 2, name: t('bread.toolLibrary', lang), item: `${siteUrl}${localePath('/tools', lang)}` },
    { '@type': 'ListItem', position: 3, name: t('bread.overview', lang), item: `${siteUrl}${pagePath}` },
  ],
};

const seoTitle = lang === 'zh'
  ? `2026 AI 编程工具全景图：${tools.length} 款工具横向对比 | CodePick`
  : `2026 AI Coding Tools Overview: ${tools.length} Tools Compared | CodePick`;
const seoDesc = lang === 'zh'
  ? `${tools.length} 款 AI 编程工具全面横向对比：Cursor、Copilot、Claude Code、Trae CN、Windsurf、Gemini CLI 等，编程能力、定价、国内可用性一览。`
  : `${tools.length} AI coding tools compared: Cursor, Copilot, Claude Code, Trae CN, Windsurf, Gemini CLI. Coding ability, pricing, and accessibility overview.`;

const dtCards = [
  { key: 'chinaFree', border: 'border-green-500' },
  { key: 'chinaPlugin', border: 'border-[var(--brand-400)]' },
  { key: 'power', border: 'border-purple-500' },
  { key: 'cheap', border: 'border-blue-500' },
  { key: 'termFree', border: 'border-yellow-500' },
  { key: 'quality', border: 'border-orange-500' },
];
---

<BaseLayout title={seoTitle} description={seoDesc} jsonLd={[jsonLd, breadcrumb]} lang={lang}>
  <section class="container py-12">
    <nav class="text-xs text-[var(--text-muted)] mb-6">
      <a href={localePath('/', lang)} class="hover:text-white no-underline">{t('bread.home', lang)}</a>
      <span class="mx-1">/</span>
      <a href={localePath('/tools', lang)} class="hover:text-white no-underline">{t('bread.toolLibrary', lang)}</a>
      <span class="mx-1">/</span>
      <span class="text-[var(--text-secondary)]">{t('bread.overview', lang)}</span>
    </nav>

    <h1 class="text-3xl font-bold text-white mb-3">{t('ov.title', lang)}</h1>
    <p class="text-[var(--text-secondary)] mb-2 max-w-2xl">
      {tools.length} {t('ov.subtitle', lang)}
    </p>
    <p class="text-xs text-[var(--text-muted)] mb-8">
      {t('ov.dimensions', lang)}
    </p>

    <div class="flex flex-wrap gap-4 mb-6 text-xs">
      <span class="text-green-400">{t('ov.excellent', lang)}</span>
      <span class="text-[var(--brand-400)]">{t('ov.good', lang)}</span>
      <span class="text-yellow-400">{t('ov.fair', lang)}</span>
      <span class="text-red-400">{t('ov.poor', lang)}</span>
    </div>

    <div class="overflow-x-auto mb-12">
      <table id="tool-table" class="compare-table w-full text-sm">
        <thead>
          <tr>
            <th class="text-left">{t('table.tool', lang)}</th>
            <th>{t('table.type', lang)}</th>
            <th>{t('table.pricing', lang)}</th>
            <th class="sortable-col cursor-pointer select-none whitespace-nowrap" data-col="coding">
              {t('score.codingAbility', lang)} <span class="sort-icon text-[var(--brand-400)]">↓</span>
            </th>
            <th class="sortable-col cursor-pointer select-none whitespace-nowrap" data-col="cost">
              {t('score.costEfficiency', lang)} <span class="sort-icon opacity-40">↕</span>
            </th>
            <th class="sortable-col cursor-pointer select-none whitespace-nowrap" data-col="flex">
              {t('score.flexibility', lang)} <span class="sort-icon opacity-40">↕</span>
            </th>
            <th class="sortable-col cursor-pointer select-none whitespace-nowrap" data-col="china">
              {t('score.chinaFriendly', lang)} <span class="sort-icon opacity-40">↕</span>
            </th>
          </tr>
        </thead>
        <tbody>
          {tools.map(tool => (
            <tr
              data-coding={String((tool as any).scores.coding_ability ?? 0)}
              data-cost={String((tool as any).scores.cost_efficiency ?? 0)}
              data-flex={String((tool as any).scores.flexibility ?? 0)}
              data-china={String((tool as any).scores.china_friendly ?? 0)}
            >
              <td>
                <a href={localePath(`/tool/${tool.id}`, lang)} class="text-[var(--brand-400)] no-underline hover:underline font-medium">
                  {tool.name}
                </a>
              </td>
              <td class="text-center">
                <span class="tag text-xs">{t(`ovType.${(tool as any).type}`, lang) || (tool as any).type}</span>
              </td>
              <td class="text-center text-[var(--text-muted)] text-xs">{priceLabel(tool as any)}</td>
              <td class={`text-center font-bold ${scoreColor((tool as any).scores.coding_ability ?? 0)}`}>
                {(tool as any).scores.coding_ability ?? '—'}
              </td>
              <td class={`text-center font-bold ${scoreColor((tool as any).scores.cost_efficiency ?? 0)}`}>
                {(tool as any).scores.cost_efficiency ?? '—'}
              </td>
              <td class={`text-center font-bold ${scoreColor((tool as any).scores.flexibility ?? 0)}`}>
                {(tool as any).scores.flexibility ?? '—'}
              </td>
              <td class={`text-center font-bold ${scoreColor((tool as any).scores.china_friendly ?? 0)}`}>
                {(tool as any).scores.china_friendly ?? '—'}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <div class="mb-12">
      <h2 class="text-xl font-bold text-white mb-6 mt-0">{t('section.decisionTree', lang)}</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {dtCards.map(card => (
          <div class={`card p-5 border-l-4 ${card.border}`}>
            <p class="text-xs text-[var(--text-muted)] mb-1">{t(`dt.${card.key}.sub`, lang)}</p>
            <p class="text-base font-bold text-white mb-2">{t(`dt.${card.key}.title`, lang)}</p>
            <p class="text-xs text-[var(--text-secondary)] m-0">{t(`dt.${card.key}.desc`, lang)}</p>
          </div>
        ))}
      </div>
    </div>

    <div class="mb-8">
      <h2 class="text-xl font-bold text-white mb-4 mt-0">{t('section.filterByScene', lang)}</h2>
      <div class="flex flex-wrap gap-3">
        <a href={localePath('/tools/free', lang)} class="btn btn-ghost text-sm no-underline">{t('cat.free', lang)}</a>
        <a href={localePath('/tools/china', lang)} class="btn btn-ghost text-sm no-underline">{t('cat.china', lang)}</a>
        <a href={localePath('/tools/vscode', lang)} class="btn btn-ghost text-sm no-underline">{t('cat.vscode', lang)}</a>
        <a href={localePath('/tools/terminal', lang)} class="btn btn-ghost text-sm no-underline">{t('cat.terminal', lang)}</a>
        <a href={localePath('/tools', lang)} class="btn btn-ghost text-sm no-underline">{t('cat.allTools', lang)}</a>
      </div>
    </div>

    <div class="text-center text-xs text-[var(--text-muted)]">
      {t('cl.dataError', lang)}
      <a href="https://github.com/WhiteWorld/codepick/issues/new" target="_blank" rel="noopener" class="text-[var(--brand-400)] no-underline hover:underline">{t('link.submitIssue', lang)}</a>
    </div>
  </section>
</BaseLayout>

<style>
  .sortable-col:hover {
    color: white;
    background-color: var(--surface-hover, rgba(255,255,255,0.05));
  }
  .sortable-col .sort-icon {
    font-size: 0.75rem;
    margin-left: 2px;
  }
</style>

<script>
  const table = document.getElementById('tool-table') as HTMLTableElement | null;
  if (table) {
    const tbody = table.querySelector('tbody') as HTMLTableSectionElement;
    const headers = table.querySelectorAll<HTMLTableCellElement>('thead th[data-col]');
    let sortCol = 'coding';
    let sortDir = -1;
    headers.forEach(th => {
      th.addEventListener('click', () => {
        const col = th.dataset.col!;
        if (col === sortCol) { sortDir *= -1; } else { sortCol = col; sortDir = -1; }
        sortTable();
        updateIcons();
      });
    });
    function sortTable() {
      const rows = Array.from(tbody.querySelectorAll<HTMLTableRowElement>('tr'));
      rows.sort((a, b) => {
        const av = parseFloat(a.dataset[sortCol] ?? '0');
        const bv = parseFloat(b.dataset[sortCol] ?? '0');
        return sortDir * (bv - av);
      });
      rows.forEach(r => tbody.appendChild(r));
    }
    function updateIcons() {
      headers.forEach(th => {
        const icon = th.querySelector<HTMLElement>('.sort-icon');
        if (!icon) return;
        if (th.dataset.col === sortCol) {
          icon.textContent = sortDir === -1 ? '↓' : '↑';
          icon.style.opacity = '1';
          icon.style.color = 'var(--brand-400)';
        } else {
          icon.textContent = '↕';
          icon.style.opacity = '0.4';
          icon.style.color = '';
        }
      });
    }
  }
</script>
