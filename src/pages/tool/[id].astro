---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ScoreBar from '../../components/ScoreBar.astro';
import { getAllTools, isFresh } from '../../lib/data';
import type { Tool } from '../../lib/data';

export function getStaticPaths() {
  const tools = getAllTools();
  return tools.map(tool => ({
    params: { id: tool.id },
    props: { tool },
  }));
}

interface Props { tool: Tool }
const { tool } = Astro.props;

const meta = (tool as any).meta || {};
const fresh = meta.next_review_due ? isFresh(meta.next_review_due) : true;
const pricingPlans = (tool as any).pricing?.plans || [];
const pricingCurrency = (tool as any).pricing?.currency || 'USD';

// features æ˜¯å¯¹è±¡ {key: value}ï¼Œè½¬ä¸ºå±•ç¤ºåˆ—è¡¨
const rawFeatures = (tool as any).features || {};
const featureLabels: Record<string, string> = {
  code_completion: 'ä»£ç è¡¥å…¨',
  chat: 'å¯¹è¯',
  agent_mode: 'Agent æ¨¡å¼',
  multi_file_edit: 'å¤šæ–‡ä»¶ç¼–è¾‘',
  mcp_support: 'MCP æ”¯æŒ',
  context_window: 'ä¸Šä¸‹æ–‡çª—å£',
  supported_models: 'æ”¯æŒæ¨¡å‹',
  git_integration: 'Git é›†æˆ',
  auto_commit: 'è‡ªåŠ¨æäº¤',
  sub_agent: 'Sub-agent',
  multi_agent: 'å¤š Agent',
  extended_thinking: 'æ·±åº¦æ€è€ƒ',
  multi_role: 'å¤šè§’è‰²',
  custom_modes: 'è‡ªå®šä¹‰æ¨¡å¼',
  tui_interface: 'TUI ç•Œé¢',
  model_providers: 'æ¨¡å‹æä¾›å•†',
};

let featureItems: {label: string, value: string}[] = [];
if (typeof rawFeatures === 'object' && !Array.isArray(rawFeatures)) {
  for (const [k, v] of Object.entries(rawFeatures)) {
    const label = featureLabels[k] || k;
    if (v === true) featureItems.push({label, value: 'âœ…'});
    else if (v === false) featureItems.push({label, value: 'â€”'});
    else if (Array.isArray(v)) featureItems.push({label, value: v.join(', ')});
    else featureItems.push({label, value: String(v)});
  }
} else if (Array.isArray(rawFeatures)) {
  featureItems = rawFeatures.map(f => ({label: String(f), value: 'âœ…'}));
}

const pros = (tool as any).pros || [];
const cons = (tool as any).cons || [];
const bestFor = (tool as any).best_for || [];
const changelog = (tool as any).changelog || [];
---

<BaseLayout title={`${tool.name} - AI ç¼–ç¨‹å·¥å…·è¯„æµ‹ | CodePick`} description={(tool as any).tagline || ''}>
  <article class="container py-12 max-w-4xl">
    <!-- Breadcrumb -->
    <nav class="text-xs text-[var(--text-muted)] mb-6">
      <a href="/" class="hover:text-white no-underline">é¦–é¡µ</a>
      <span class="mx-1">/</span>
      <a href="/tools" class="hover:text-white no-underline">å·¥å…·åº“</a>
      <span class="mx-1">/</span>
      <span class="text-[var(--text-secondary)]">{tool.name}</span>
    </nav>

    <!-- Header -->
    <div class="flex items-start gap-4 mb-8">
      <div class="w-16 h-16 rounded-xl bg-[var(--surface-card)] flex items-center justify-center text-2xl font-bold text-[var(--brand-400)] border border-[var(--surface-border)]">
        {tool.name.charAt(0)}
      </div>
      <div class="flex-1">
        <h1 class="text-2xl md:text-3xl font-bold text-white mb-1 mt-0">{tool.name}</h1>
        <p class="text-[var(--text-secondary)] m-0 mb-2">{(tool as any).tagline || ''}</p>
        <div class="flex items-center gap-3 flex-wrap">
          {(tool as any).type && <span class="tag tag-primary">{(tool as any).type}</span>}
          {(tool as any).url && (
            <a href={(tool as any).url} target="_blank" rel="noopener" class="text-xs text-[var(--brand-400)] no-underline">
              å®˜ç½‘ â†—
            </a>
          )}
          {!fresh && <span class="text-xs text-amber-400">âš  æ•°æ®å¯èƒ½è¿‡æ—¶ï¼Œè¯·ä»¥å®˜ç½‘ä¸ºå‡†</span>}
        </div>
      </div>
    </div>

    <!-- Scores -->
    {(tool as any).scores && (
      <section class="card p-6 mb-8">
        <h2 class="text-lg font-semibold text-white mb-4 mt-0">ğŸ“Š è¯„åˆ†</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="flex flex-col gap-3">
            <ScoreBar label="ç¼–ç¨‹èƒ½åŠ›" score={(tool as any).scores.coding_ability ?? 5} color="auto" />
            <ScoreBar label="æ€§ä»·æ¯”" score={(tool as any).scores.cost_efficiency ?? 5} color="auto" />
          </div>
          <div class="flex flex-col gap-3">
            <ScoreBar label="çµæ´»æ€§" score={(tool as any).scores.flexibility ?? 5} color="auto" />
            <ScoreBar label="å›½å†…ä½“éªŒ" score={(tool as any).scores.china_friendly ?? 5} color="auto" />
          </div>
        </div>
      </section>
    )}

    <!-- Pricing -->
    {pricingPlans.length > 0 && (
      <section class="card p-6 mb-8">
        <h2 class="text-lg font-semibold text-white mb-4 mt-0">ğŸ’² å®šä»·</h2>
        <div class="overflow-x-auto">
          <table class="compare-table">
            <thead>
              <tr>
                <th>æ–¹æ¡ˆ</th>
                <th>ä»·æ ¼</th>
                <th>é™åˆ¶</th>
              </tr>
            </thead>
            <tbody>
              {pricingPlans.map((p: any) => (
                <tr>
                  <td class="font-medium">{p.name}</td>
                  <td>{typeof p.price === 'number' ? `${pricingCurrency === 'CNY' ? 'Â¥' : '$'}${p.price}/æœˆ` : p.price}</td>
                  <td class="text-[var(--text-muted)]">{p.limits || 'â€”'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </section>
    )}

    <!-- Features -->
    {featureItems.length > 0 && (
      <section class="card p-6 mb-8">
        <h2 class="text-lg font-semibold text-white mb-4 mt-0">âœ¨ æ ¸å¿ƒåŠŸèƒ½</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
          {featureItems.map(f => (
            <div class="flex justify-between text-sm py-1.5 border-b border-[var(--surface-border)]">
              <span class="text-[var(--text-secondary)]">{f.label}</span>
              <span class="text-white font-medium">{f.value}</span>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- Pros & Cons -->
    {(Array.isArray(pros) && pros.length > 0 || Array.isArray(cons) && cons.length > 0) && (
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8">
        {Array.isArray(pros) && pros.length > 0 && (
          <div class="card p-6">
            <h3 class="text-base font-semibold text-green-400 mb-3 mt-0">âœ… ä¼˜åŠ¿</h3>
            <ul class="list-none text-sm text-[var(--text-secondary)] space-y-1.5 m-0 p-0">
              {pros.map((p: string) => <li>+ {p}</li>)}
            </ul>
          </div>
        )}
        {Array.isArray(cons) && cons.length > 0 && (
          <div class="card p-6">
            <h3 class="text-base font-semibold text-red-400 mb-3 mt-0">âš ï¸ åŠ£åŠ¿</h3>
            <ul class="list-none text-sm text-[var(--text-secondary)] space-y-1.5 m-0 p-0">
              {cons.map((c: string) => <li>- {c}</li>)}
            </ul>
          </div>
        )}
      </div>
    )}

    <!-- Best For -->
    {Array.isArray(bestFor) && bestFor.length > 0 && (
      <section class="card p-6 mb-8">
        <h2 class="text-lg font-semibold text-white mb-4 mt-0">ğŸ¯ æœ€é€‚åˆ</h2>
        <div class="flex flex-wrap gap-2">
          {bestFor.map((b: string) => <span class="tag tag-primary">{b}</span>)}
        </div>
      </section>
    )}

    <!-- Changelog -->
    {Array.isArray(changelog) && changelog.length > 0 && (
      <section class="card p-6 mb-8">
        <h2 class="text-lg font-semibold text-white mb-4 mt-0">ğŸ“ æ›´æ–°è®°å½•</h2>
        <div class="space-y-3">
          {changelog.slice(0, 5).map((log: any) => (
            <div class="flex gap-3 text-sm">
              <span class="text-[var(--text-muted)] shrink-0 w-24">{log.date}</span>
              {log.version && <span class="tag shrink-0">{log.version}</span>}
              <span class="text-[var(--text-secondary)]">{log.summary}</span>
            </div>
          ))}
        </div>
      </section>
    )}

    <!-- Meta -->
    {(meta.last_verified || meta.confidence) && (
      <div class="text-xs text-[var(--text-muted)] flex flex-wrap gap-4 mt-8">
        {meta.last_verified && <span>æœ€åéªŒè¯: {meta.last_verified}</span>}
        {meta.next_review_due && <span>ä¸‹æ¬¡è¯„å®¡: {meta.next_review_due}</span>}
        {meta.confidence && <span>æ•°æ®ä¿¡å¿ƒ: {meta.confidence}</span>}
        <a href="https://github.com/WhiteWorld/codepick/issues/new" target="_blank" rel="noopener" class="text-[var(--brand-400)] no-underline">
          æŠ¥å‘Šé”™è¯¯ â†’
        </a>
      </div>
    )}
  </article>
</BaseLayout>
