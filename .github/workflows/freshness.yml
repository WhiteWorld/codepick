name: Data Freshness Check

on:
  # æ¯å‘¨ä¸€æ—©ä¸Š9ç‚¹(åŒ—äº¬æ—¶é—´)è‡ªåŠ¨æ£€æŸ¥
  schedule:
    - cron: '0 1 * * 1'  # UTC 01:00 = åŒ—äº¬ 09:00
  # ä¹Ÿå¯ä»¥æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check data freshness
        id: freshness
        run: node scripts/check-freshness.mjs
        continue-on-error: true

      - name: Create issue if stale
        if: steps.freshness.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const output = execSync('node scripts/check-freshness.mjs 2>&1 || true').toString();
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰ open çš„ freshness issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'data-freshness'
            });
            
            if (issues.data.length > 0) {
              // æ›´æ–°å·²æœ‰ issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## æ•°æ®æ–°é²œåº¦æ£€æŸ¥æŠ¥å‘Š\n\n\`\`\`\n${output}\n\`\`\`\n\n*è‡ªåŠ¨ç”Ÿæˆäº ${new Date().toISOString()}*`
              });
            } else {
              // åˆ›å»ºæ–° issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ“Š æ•°æ®éœ€è¦æ›´æ–°',
                body: `## æ•°æ®æ–°é²œåº¦æ£€æŸ¥æŠ¥å‘Š\n\n\`\`\`\n${output}\n\`\`\`\n\n*è‡ªåŠ¨ç”Ÿæˆäº ${new Date().toISOString()}*`,
                labels: ['data-freshness']
              });
            }
